<% // views/broadcast-form.ejs (–§–ò–ù–ê–õ–¨–ù–ê–Ø –í–ï–†–°–ò–Ø –° –ò–°–ü–†–ê–í–õ–ï–ù–ù–û–ô –õ–û–ì–ò–ö–û–ô) %>
<%- contentFor('body') %>

<%# --- –í–û–¢ –ì–õ–ê–í–ù–´–ô –§–ò–ö–° --- %>
<% const isEditing = typeof task !== 'undefined' && task && task.id; %>

<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
  <h1 class="h2"><%= isEditing ? '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ä–∞—Å—Å—ã–ª–∫—É' : '–°–æ–∑–¥–∞—Ç—å —Ä–∞—Å—Å—ã–ª–∫—É' %></h1>
  <a href="/broadcasts" class="btn btn-sm btn-outline-secondary"><i class="bi bi-arrow-left"></i> –ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É</a>
</div>

<% if (success) { %><div class="alert alert-success"><%= success %></div><% } %>
<% if (error) { %><div class="alert alert-danger"><%= error %></div><% } %>

<div class="card shadow-sm">
  <div class="card-body">
    <form id="broadcastForm" method="POST" action="<%= isEditing ? '/broadcast/edit/' + task.id : '/broadcast/new' %>" enctype="multipart/form-data">

      <div class="mb-3">
        <label for="message" class="form-label">–¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è</label>
        <textarea name="message" id="message" class="form-control" rows="5" required><%= (typeof task !== 'undefined' && task.message) ? task.message : '' %></textarea>
        <div class="form-text">–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è <b>HTML-—Ä–∞–∑–º–µ—Ç–∫–∞</b> –∏ —Ç–µ–≥ <code>{first_name}</code> –¥–ª—è –æ–±—Ä–∞—â–µ–Ω–∏—è –ø–æ –∏–º–µ–Ω–∏.</div>
      </div>

      <div class="mb-3">
        <label for="buttons" class="form-label">–ò–Ω–ª–∞–π–Ω-–∫–Ω–æ–ø–∫–∏ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
        <textarea name="buttons" id="buttons" class="form-control" rows="3" placeholder="–¢–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏ | —Ç–∏–ø | –¥–∞–Ω–Ω—ã–µ (–∫–∞–∂–¥–∞—è –∫–Ω–æ–ø–∫–∞ —Å –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏)"><%= (typeof task !== 'undefined' && task.buttons_text) ? task.buttons_text : '' %></textarea>
        <div class="form-text">
          –¢–∏–ø—ã: <code>url</code>, <code>callback</code>, <code>inline_search</code>. –ü—Ä–∏–º–µ—Ä: <code>–ù–∞—à –∫–∞–Ω–∞–ª | url | https://t.me/your_channel</code>
        </div>
      </div>

      <div class="row">
        <div class="col-md-6 mb-3">
          <label for="file" class="form-label">–§–∞–π–ª (—Ñ–æ—Ç–æ, –≤–∏–¥–µ–æ, –∞—É–¥–∏–æ, –¥–æ–∫—É–º–µ–Ω—Ç)</label>
          <input type="file" name="file" id="file" class="form-control" />
          <% if (isEditing && (task.audio_path || task.file_path || task.file_id)) { %>
            <div class="form-text">–ü—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω —Ñ–∞–π–ª. –ó–∞–≥—Ä—É–∑–∫–∞ –Ω–æ–≤–æ–≥–æ –∑–∞–º–µ–Ω–∏—Ç –µ–≥–æ.</div>
          <% } %>
        </div>
        <div class="col-md-6 mb-3">
          <label for="targetAudience" class="form-label">–ê—É–¥–∏—Ç–æ—Ä–∏—è</label>
          <select class="form-select" id="targetAudience" name="targetAudience">
            <option value="all" <%= (isEditing && task.target_audience === 'all') ? 'selected' : '' %>>–í—Å–µ–º –∞–∫—Ç–∏–≤–Ω—ã–º</option>
            <option value="free_users" <%= (isEditing && task.target_audience === 'free_users') ? 'selected' : '' %>>–¢–æ–ª—å–∫–æ Free</option>
            <option value="premium_users" <%= (isEditing && task.target_audience === 'premium_users') ? 'selected' : '' %>>–¢–æ–ª—å–∫–æ Premium</option>
          </select>
        </div>
      </div>

      <div class="row align-items-end">
        <div class="col-md-6 mb-3">
          <label for="localScheduledAt" class="form-label">–ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ (–≤–∞—à–µ –ª–æ–∫–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è)</label>
          <input type="datetime-local" class="form-control" id="localScheduledAt" value="<%= isEditing && task.scheduled_at ? new Date(new Date(task.scheduled_at).getTime() - (new Date().getTimezoneOffset() * 60000)).toISOString().slice(0, 16) : '' %>">
          <input type="hidden" name="scheduledAt" id="scheduledAt">
        </div>
        <div class="col-md-6 mb-3 d-flex flex-wrap gap-3">
          <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" name="disable_notification" id="disable_notification" <%= (isEditing && task.disable_notification) ? 'checked' : '' %>>
            <label class="form-check-label" for="disable_notification">–¢–∏—Ö–∞—è —Ä–∞—Å—Å—ã–ª–∫–∞</label>
          </div>
          <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" name="enable_web_page_preview" id="enable_web_page_preview" <%= (isEditing && !task.disable_web_page_preview) ? 'checked' : '' %>>
            <label class="form-check-label" for="enable_web_page_preview">–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä —Å—Å—ã–ª–∫–∏</label>
          </div>
        </div>
      </div>

      <div class="d-flex flex-wrap gap-2">
        <% if (!isEditing) { %><button type="submit" name="action" value="preview" class="btn btn-outline-secondary">–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä</button><% } %>
        <button type="submit" name="action" value="send" class="btn btn-primary flex-grow-1" onclick="return confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã?')">üöÄ <%= isEditing ? '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å' : '–û—Ç–ø—Ä–∞–≤–∏—Ç—å/–ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞—Ç—å' %></button>
      </div>
    </form>
  </div>
</div>

<script>
  document.getElementById('broadcastForm').addEventListener('submit', function(event) {
    const localTimeInput = document.getElementById('localScheduledAt');
    const utcTimeInput = document.getElementById('scheduledAt');
    if (localTimeInput.value) {
      utcTimeInput.value = new Date(localTimeInput.value).toISOString();
    }
  });
</script>