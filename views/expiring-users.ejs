<% // views/expiring-users.ejs %>

<%
// –•–µ–ª–ø–µ—Ä—ã
function tariffLabel(limit) {
  if (limit >= 1000) return 'Unlimited';
  if (limit === 100) return 'Pro';
  if (limit === 30) return 'Plus';
  return 'Free';
}

function tariffBadge(limit) {
  if (limit >= 1000) return 'bg-primary';
  if (limit === 100) return 'bg-warning text-dark';
  if (limit === 30) return 'bg-info text-dark';
  return 'bg-secondary';
}

function formatDate(s) {
  if (!s) return '‚Äî';
  try {
    const d = new Date(s);
    if (isNaN(d.getTime())) return '‚Äî';
    return d.toLocaleDateString('ru-RU', { day: '2-digit', month: '2-digit', year: 'numeric' });
  } catch (e) {
    return '‚Äî';
  }
}

function daysUntil(s) {
  if (!s) return null;
  const now = new Date();
  const target = new Date(s);
  const diff = Math.ceil((target - now) / (1000 * 60 * 60 * 24));
  return diff;
}
%>

<%- contentFor('styles') %>
<style>
  .stat-card {
    background: var(--bs-card-bg);
    border: 1px solid var(--bs-border-color);
    border-radius: 10px;
    padding: 1rem;
    text-align: center;
  }
  .stat-card .stat-value {
    font-size: 1.5rem;
    font-weight: 700;
  }
  .stat-card .stat-label {
    font-size: 0.8rem;
    color: #6c757d;
  }
  .days-badge {
    min-width: 60px;
    display: inline-block;
  }
</style>

<%- contentFor('body') %>

<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
  <h1 class="h2">‚è≥ –ò—Å—Ç–µ–∫–∞—é—â–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏</h1>
</div>

<!-- –ö–∞—Ä—Ç–æ—á–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ -->
<div class="row g-3 mb-4">
  <div class="col-6 col-md-3">
    <div class="stat-card">
      <div class="stat-value text-danger"><%= typeof expiringToday !== 'undefined' ? expiringToday : 0 %></div>
      <div class="stat-label">üî¥ –°–µ–≥–æ–¥–Ω—è</div>
    </div>
  </div>
  <div class="col-6 col-md-3">
    <div class="stat-card">
      <div class="stat-value text-warning"><%= typeof expiring2to3Days !== 'undefined' ? expiring2to3Days : 0 %></div>
      <div class="stat-label">üü† 2-3 –¥–Ω—è</div>
    </div>
  </div>
  <div class="col-6 col-md-3">
    <div class="stat-card">
      <div class="stat-value text-info"><%= typeof expiring4to7Days !== 'undefined' ? expiring4to7Days : 0 %></div>
      <div class="stat-label">üü° 4-7 –¥–Ω–µ–π</div>
    </div>
  </div>
  <div class="col-6 col-md-3">
    <div class="stat-card">
      <div class="stat-value text-primary"><%= typeof totalExpiring !== 'undefined' ? totalExpiring : 0 %></div>
      <div class="stat-label">üìä –í—Å–µ–≥–æ</div>
    </div>
  </div>
</div>

<!-- –§–∏–ª—å—Ç—Ä—ã -->
<form id="filterForm" class="row g-3 mb-4">
  <div class="col-md-3">
    <label class="form-label small text-muted">–ü–æ–∏—Å–∫</label>
    <input type="text" class="form-control" id="searchInput" placeholder="ID, –∏–º—è, @username...">
  </div>
  <div class="col-md-2">
    <label class="form-label small text-muted">–¢–∞—Ä–∏—Ñ</label>
    <select class="form-select" id="tariffFilter">
      <option value="">–í—Å–µ</option>
      <option value="Plus">Plus</option>
      <option value="Pro">Pro</option>
      <option value="Unlimited">Unlimited</option>
    </select>
  </div>
  <div class="col-md-2">
    <label class="form-label small text-muted">–ò—Å—Ç–µ–∫–∞–µ—Ç —á–µ—Ä–µ–∑</label>
    <select class="form-select" id="daysFilter">
      <option value="">–í—Å–µ</option>
      <option value="1">–°–µ–≥–æ–¥–Ω—è</option>
      <option value="3">–î–æ 3 –¥–Ω–µ–π</option>
      <option value="7">–î–æ 7 –¥–Ω–µ–π</option>
    </select>
  </div>
  <div class="col-md-2 d-flex align-items-end">
    <button type="button" class="btn btn-outline-secondary w-100" onclick="resetFilters()">–°–±—Ä–æ—Å–∏—Ç—å</button>
  </div>
</form>

<div class="card shadow-sm">
  <div class="card-body p-0">
    <div class="table-responsive">
      <table class="table table-hover mb-0 align-middle" id="expiringTable">
        <thead class="table-light">
          <tr>
            <th>ID</th>
            <th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th>
            <th>–¢–∞—Ä–∏—Ñ</th>
            <th>–ò—Å—Ç–µ–∫–∞–µ—Ç</th>
            <th>–û—Å—Ç–∞–ª–æ—Å—å</th>
            <th>–î–µ–π—Å—Ç–≤–∏—è</th>
          </tr>
        </thead>
        <tbody>
          <% if (typeof users !== 'undefined' && users.length > 0) { %>
            <% users.forEach(u => { 
              const days = daysUntil(u.premium_until);
              const tariff = tariffLabel(u.premium_limit);
            %>
              <tr data-search="<%= (u.id + ' ' + (u.first_name || '') + ' ' + (u.username || '')).toLowerCase() %>"
                  data-tariff="<%= tariff %>"
                  data-days="<%= days %>">
                <td><a href="/user/<%= u.id %>" class="font-monospace"><%= u.id %></a></td>
                <td>
                  <div class="fw-semibold"><%= u.first_name || '–ë–µ–∑ –∏–º–µ–Ω–∏' %></div>
                  <div class="text-muted small"><%= u.username ? '@'+u.username : '' %></div>
                </td>
                <td>
                  <span class="badge <%= tariffBadge(u.premium_limit) %>"><%= tariff %></span>
                </td>
                <td class="text-nowrap"><%= formatDate(u.premium_until) %></td>
                <td>
                  <% if (days !== null) { %>
                    <% if (days <= 0) { %>
                      <span class="badge bg-danger days-badge">–ò—Å—Ç—ë–∫</span>
                    <% } else if (days === 1) { %>
                      <span class="badge bg-danger days-badge">–°–µ–≥–æ–¥–Ω—è</span>
                    <% } else if (days <= 3) { %>
                      <span class="badge bg-warning text-dark days-badge"><%= days %> –¥–Ω.</span>
                    <% } else { %>
                      <span class="badge bg-info text-dark days-badge"><%= days %> –¥–Ω.</span>
                    <% } %>
                  <% } else { %>
                    <span class="text-muted">‚Äî</span>
                  <% } %>
                </td>
                <td>
                  <div class="btn-group btn-group-sm">
                    <a href="/user/<%= u.id %>" class="btn btn-outline-primary" title="–ü—Ä–æ—Ñ–∏–ª—å">
                      <i class="bi bi-person"></i>
                    </a>
                    <form action="/set-tariff" method="POST" class="d-inline">
                      <input type="hidden" name="userId" value="<%= u.id %>">
                      <input type="hidden" name="limit" value="<%= u.premium_limit %>">
                      <input type="hidden" name="days" value="30">
                      <input type="hidden" name="applyMode" value="extend">
                      <button type="submit" class="btn btn-outline-success" title="–ü—Ä–æ–¥–ª–∏—Ç—å –Ω–∞ 30 –¥–Ω–µ–π"
                              onclick="return confirm('–ü—Ä–æ–¥–ª–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É –Ω–∞ 30 –¥–Ω–µ–π?')">
                        <i class="bi bi-plus-circle"></i>
                      </button>
                    </form>
                  </div>
                </td>
              </tr>
            <% }) %>
          <% } else { %>
            <tr>
              <td colspan="6" class="text-center text-muted py-5">
                <i class="bi bi-check-circle fs-1 text-success opacity-50"></i>
                <p class="h5 mt-3">–ù–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å –∏—Å—Ç–µ–∫–∞—é—â–µ–π –ø–æ–¥–ø–∏—Å–∫–æ–π</p>
                <p class="mb-0">–í—Å–µ –ø–æ–¥–ø–∏—Å–∫–∏ –≤ –ø–æ—Ä—è–¥–∫–µ.</p>
              </td>
            </tr>
          <% } %>
        </tbody>
      </table>
    </div>
  </div>
</div>

<p class="text-muted text-center mt-3" id="resultsCount">
  –ü–æ–∫–∞–∑–∞–Ω–æ <span id="visibleCount"><%= users ? users.length : 0 %></span> –∏–∑ <%= users ? users.length : 0 %> –∑–∞–ø–∏—Å–µ–π
</p>

<script>
function filterTable() {
  const search = document.getElementById('searchInput').value.toLowerCase();
  const tariff = document.getElementById('tariffFilter').value;
  const days = document.getElementById('daysFilter').value;
  
  const rows = document.querySelectorAll('#expiringTable tbody tr');
  let visible = 0;
  
  rows.forEach(row => {
    if (!row.dataset.search) return; // Skip empty row
    
    let show = true;
    
    // Search filter
    if (search && !row.dataset.search.includes(search)) {
      show = false;
    }
    
    // Tariff filter
    if (tariff && row.dataset.tariff !== tariff) {
      show = false;
    }
    
    // Days filter
    if (days) {
      const rowDays = parseInt(row.dataset.days);
      if (isNaN(rowDays) || rowDays > parseInt(days)) {
        show = false;
      }
    }
    
    row.style.display = show ? '' : 'none';
    if (show) visible++;
  });
  
  document.getElementById('visibleCount').textContent = visible;
}

function resetFilters() {
  document.getElementById('searchInput').value = '';
  document.getElementById('tariffFilter').value = '';
  document.getElementById('daysFilter').value = '';
  filterTable();
}

// Attach listeners
document.getElementById('searchInput').addEventListener('input', filterTable);
document.getElementById('tariffFilter').addEventListener('change', filterTable);
document.getElementById('daysFilter').addEventListener('change', filterTable);
</script>
