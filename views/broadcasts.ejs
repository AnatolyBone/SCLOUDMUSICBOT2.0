<%# views/broadcasts.ejs (–±–µ–∑–æ–ø–∞—Å–Ω–∞—è —Ñ–∏–Ω–∞–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è —Å –º–æ—Å–∫–æ–≤—Å–∫–∏–º –≤—Ä–µ–º–µ–Ω–µ–º) %>

<%# === –•–µ–ª–ø–µ—Ä—ã –∏ —Ñ—É–Ω–∫—Ü–∏–∏ === %>
<% 
  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è HTML (–ó–ê–©–ò–¢–ê –û–¢ XSS)
  const escapeHtml = (str) => {
    if (str === undefined || str === null) return '';
    return String(str)
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;')
      .replace(/'/g, '&#039;');
  };

  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –¥–∞—Ç—ã –ø–æ –ú–°–ö
  const formatMoscowTime = (dateStr) => {
    if (!dateStr) return '‚Äî';
    try {
      const date = new Date(dateStr);
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –¥–∞—Ç–∞ –≤–∞–ª–∏–¥–Ω–∞
      if (isNaN(date.getTime())) return '–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –¥–∞—Ç–∞';
      
      return date.toLocaleString('ru-RU', {
        timeZone: 'Europe/Moscow',
        day: '2-digit',
        month: '2-digit',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });
    } catch (e) {
      console.error('–û—à–∏–±–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –¥–∞—Ç—ã:', e);
      return '–û—à–∏–±–∫–∞ –¥–∞—Ç—ã';
    }
  };
%>

<%- contentFor('styles') %>
<style>
  .table-responsive .table {
    min-width: 800px;
  }
  .preview-cell {
    max-width: 350px;
  }
  .table .badge {
    min-width: 85px;
    text-align: center;
  }
</style>

<%- contentFor('body') %>

<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
  <div class="d-flex align-items-center gap-2">
    <h1 class="h2 mb-0"><i class="bi bi-broadcast me-2"></i>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–∞—Å—Å—ã–ª–∫–∞–º–∏</h1>
    <span class="badge bg-secondary" data-bs-toggle="tooltip" title="–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –≤—Ä–µ–º—è –≤ –ú–æ—Å–∫–≤–µ">–ú–°–ö</span>
  </div>
  <div class="btn-toolbar mb-2 mb-md-0 gap-2">
    <button class="btn btn-sm btn-outline-secondary" onclick="location.reload()">
      <i class="bi bi-arrow-clockwise me-1"></i>–û–±–Ω–æ–≤–∏—Ç—å
    </button>
    <button class="btn btn-sm btn-outline-primary" onclick="exportCsv()">
      <i class="bi bi-download me-1"></i>–≠–∫—Å–ø–æ—Ä—Ç CSV
    </button>
    <a href="/broadcast/new" class="btn btn-sm btn-primary">
      <i class="bi bi-plus-circle me-1"></i>–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é
    </a>
  </div>
</div>

<% if (tasks && tasks.length) { 
  const total = tasks.length;
  const pending = tasks.filter(t => t.status === 'pending').length;
  const processing = tasks.filter(t => t.status === 'processing').length;
  const completed = tasks.filter(t => t.status === 'completed').length;
  const failed = tasks.filter(t => t.status === 'failed').length;
%>
<div class="row g-3 mb-3">
  <div class="col-md-3 col-6">
    <div class="card border-0 shadow-sm h-100">
      <div class="card-body text-center">
        <div class="text-muted small">–í—Å–µ–≥–æ</div>
        <div class="fs-4 fw-semibold"><%= total %></div>
      </div>
    </div>
  </div>
  <div class="col-md-3 col-6">
    <div class="card border-0 shadow-sm h-100">
      <div class="card-body text-center">
        <div class="text-muted small">–í –æ–∂–∏–¥–∞–Ω–∏–∏</div>
        <div class="fs-4 fw-semibold text-warning"><%= pending %></div>
      </div>
    </div>
  </div>
  <div class="col-md-3 col-6">
    <div class="card border-0 shadow-sm h-100">
      <div class="card-body text-center">
        <div class="text-muted small">–í –ø—Ä–æ—Ü–µ—Å—Å–µ</div>
        <div class="fs-4 fw-semibold text-info"><%= processing %></div>
      </div>
    </div>
  </div>
  <div class="col-md-3 col-6">
    <div class="card border-0 shadow-sm h-100">
      <div class="card-body text-center">
        <div class="text-muted small">–ó–∞–≤–µ—Ä—à–µ–Ω–æ / –û—à–∏–±–∫–∞</div>
        <div class="fs-4 fw-semibold">
          <span class="text-success me-2"><%= completed %></span>
          <span class="text-danger"><%= failed %></span>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="card mb-3">
  <div class="card-body">
    <div class="row g-3">
      <div class="col-md-4">
        <label class="form-label">üîç –ü–æ–∏—Å–∫</label>
        <input type="text" id="searchInput" class="form-control" placeholder="–¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –∏–ª–∏ ID" oninput="filterTable()">
      </div>
      <div class="col-md-3">
        <label class="form-label">–°—Ç–∞—Ç—É—Å</label>
        <select id="statusFilter" class="form-select" onchange="filterTable()">
          <option value="">–í—Å–µ</option>
          <option value="pending">–í –æ–∂–∏–¥–∞–Ω–∏–∏</option>
          <option value="processing">–í –ø—Ä–æ—Ü–µ—Å—Å–µ</option>
          <option value="completed">–ó–∞–≤–µ—Ä—à–µ–Ω–∞</option>
          <option value="failed">–û—à–∏–±–∫–∞</option>
        </select>
      </div>
      <div class="col-md-3">
        <label class="form-label">–ê—É–¥–∏—Ç–æ—Ä–∏—è</label>
        <select id="audienceFilter" class="form-select" onchange="filterTable()">
          <option value="">–í—Å–µ</option>
          <option value="all_users">–í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</option>
          <option value="free_users">Free</option>
          <option value="premium_users">Premium</option>
        </select>
      </div>
      <div class="col-md-2 d-flex align-items-end">
        <button class="btn btn-outline-secondary w-100" onclick="clearFilters()">–°–±—Ä–æ—Å–∏—Ç—å</button>
      </div>
    </div>
  </div>
</div>
<% } %>

<div class="table-responsive">
  <table class="table table-hover align-middle" id="broadcastsTable">
    <thead class="table-light">
      <tr>
        <th scope="col">ID</th>
        <th scope="col">–°—Ç–∞—Ç—É—Å</th>
        <th scope="col">–ê—É–¥–∏—Ç–æ—Ä–∏—è</th>
        <th scope="col">–°–æ–æ–±—â–µ–Ω–∏–µ</th>
        <th scope="col">–ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–æ –Ω–∞ (–ú–°–ö)</th>
        <th scope="col" class="text-center">–ü—Ä–æ–≥—Ä–µ—Å—Å</th>
        <th scope="col" class="text-center">–î–µ–π—Å—Ç–≤–∏—è</th>
      </tr>
    </thead>
    <tbody>
      <% if (tasks && tasks.length > 0) { %>
        <% tasks.forEach(task => { 
          const safeMessage = escapeHtml(task.message);
          
          const statusMap = {
            pending: { name: '–í –æ–∂–∏–¥–∞–Ω–∏–∏', class: 'bg-warning text-dark' },
            processing: { name: '–í –ø—Ä–æ—Ü–µ—Å—Å–µ', class: 'bg-info text-dark' },
            completed: { name: '–ó–∞–≤–µ—Ä—à–µ–Ω–∞', class: 'bg-success' },
            failed: { name: '–û—à–∏–±–∫–∞', class: 'bg-danger' }
          };
          const status = statusMap[task.status] || { name: task.status, class: 'bg-secondary' };
          
          const audienceMap = {
            all_users: '–í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏',
            free_users: 'Free –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏',
            premium_users: 'Premium –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏'
          };
          const audience = audienceMap[task.target_audience] || (task.target_audience ? task.target_audience.replace('_', ' ') : '');
          
          const sent = task.sent_count || 0;
          const total = task.total_count || 0;
          const progress = total > 0 ? Math.round((sent / total) * 100) : 0;
        %>
          <tr data-id="<%= task.id %>"
              data-status="<%= task.status %>"
              data-audience="<%= task.target_audience %>"
              data-message="<%= (task.message || '').toLowerCase() %>">
            <td class="fw-semibold">#<%= task.id %></td>
            <td>
              <span class="badge <%= status.class %>"><%- status.name %></span>
            </td>
            <td><%= audience %></td>
            <td class="text-truncate preview-cell" 
                data-bs-toggle="tooltip"
                title="<%- safeMessage || '(—Ç–æ–ª—å–∫–æ –º–µ–¥–∏–∞—Ñ–∞–π–ª)' %>">
              <% if (task.file_id) { %>
                <i class="bi bi-paperclip text-muted me-1"></i>
              <% } %>
              <%- safeMessage || '<i>(—Ç–æ–ª—å–∫–æ –º–µ–¥–∏–∞—Ñ–∞–π–ª)</i>' %>
            </td>
            
            <%# --- –í—Ä–µ–º—è –ø–æ –ú–°–ö --- %>
            <td data-bs-toggle="tooltip" title="–í—Ä–µ–º—è —É–∫–∞–∑–∞–Ω–æ –ø–æ –ú–°–ö (UTC+3)">
              <%= formatMoscowTime(task.scheduled_at) %>
            </td>
            
            <td class="text-center">
              <% if (task.status === 'processing' || task.status === 'completed') { %>
                <div class="progress" 
                     style="height: 22px; font-size: 0.8rem;" 
                     data-bs-toggle="tooltip" 
                     title="–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ: <%= sent %> –∏–∑ <%= total %>">
                  <div class="progress-bar progress-bar-striped progress-bar-animated" 
                       role="progressbar" 
                       data-progress="<%= progress %>" 
                       aria-valuenow="<%= progress %>" 
                       aria-valuemin="0" 
                       aria-valuemax="100">
                    <%= progress %>%
                  </div>
                </div>
              <% } else if (task.status === 'pending') { %>
                <span class="badge bg-warning-subtle text-warning border border-warning-subtle px-3">
                  –û–∂–∏–¥–∞–µ—Ç –∑–∞–ø—É—Å–∫–∞
                </span>
              <% } else if (task.status === 'failed' && task.report?.error) { %>
                <i class="bi bi-exclamation-triangle-fill text-danger fs-5" 
                   data-bs-toggle="tooltip" 
                   title="<%- escapeHtml(task.report.error) %>"></i>
              <% } else { %>
                <span class="text-muted">‚Äî</span>
              <% } %>
            </td>
            <td class="text-center">
              <div class="btn-group btn-group-sm">
                <% if (task.status === 'pending') { %>
                  <a href="/broadcast/edit/<%= task.id %>" 
                     class="btn btn-outline-primary"
                     title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">
                    <i class="bi bi-pencil-fill"></i>
                  </a>
                <% } %>
                <form method="POST" action="/broadcast/delete" class="d-inline" onsubmit="return confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç—É —Ä–∞—Å—Å—ã–ª–∫—É?');">
                  <input type="hidden" name="taskId" value="<%= task.id %>">
                  <button type="submit" class="btn btn-outline-danger" title="–£–¥–∞–ª–∏—Ç—å">
                    <i class="bi bi-trash-fill"></i>
                  </button>
                </form>
              </div>
            </td>
          </tr>
        <% }) %>
      <% } else { %>
        <tr>
          <td colspan="7" class="text-center text-muted py-5">
            <div class="mb-3">
              <i class="bi bi-inbox" style="font-size: 3rem; opacity: 0.3;"></i>
            </div>
            <p class="mb-0">–ù–µ—Ç –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Ä–∞—Å—Å—ã–ª–æ–∫</p>
            <p><a href="/broadcast/new">–°–æ–∑–¥–∞—Ç—å –ø–µ—Ä–≤—É—é —Ä–∞—Å—Å—ã–ª–∫—É</a></p>
          </td>
        </tr>
      <% } %>
    </tbody>
  </table>
</div>

<script>
// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ç—É–ª—Ç–∏–ø–æ–≤
document.addEventListener('DOMContentLoaded', () => {
  const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
  tooltipTriggerList.map(t => new bootstrap.Tooltip(t));

  // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —à–∏—Ä–∏–Ω—É –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä–æ–≤ –∏–∑ data-progress
  document.querySelectorAll('.progress-bar[data-progress]').forEach(el => {
    const p = parseInt(el.dataset.progress, 10) || 0;
    el.style.width = `${p}%`;
  });
});

function filterTable() {
  const search = (document.getElementById('searchInput')?.value || '').toLowerCase();
  const status = document.getElementById('statusFilter')?.value || '';
  const audience = document.getElementById('audienceFilter')?.value || '';
  const rows = document.querySelectorAll('#broadcastsTable tbody tr');
  
  rows.forEach(row => {
    const rowStatus = row.dataset.status || '';
    const rowAudience = row.dataset.audience || '';
    const rowMsg = row.dataset.message || '';
    const idText = row.dataset.id || '';
    
    let show = true;
    if (status && rowStatus !== status) show = false;
    if (audience && rowAudience !== audience) show = false;
    if (search && !rowMsg.includes(search) && !idText.includes(search)) show = false;
    
    row.style.display = show ? '' : 'none';
  });
}

function clearFilters() {
  const s = document.getElementById('searchInput');
  const st = document.getElementById('statusFilter');
  const a = document.getElementById('audienceFilter');
  if (s) s.value = '';
  if (st) st.value = '';
  if (a) a.value = '';
  filterTable();
}

function exportCsv() {
  const rows = Array.from(document.querySelectorAll('#broadcastsTable tbody tr'));
  if (!rows.length) return;
  const headers = ['id','status','audience','message','scheduled_at','sent','total','progress'];
  const lines = [headers.join(',')];
  
  rows.forEach(row => {
    const cols = row.querySelectorAll('td');
    const id = cols[0]?.innerText.replace('#','').trim() || '';
    const status = (row.dataset.status || '').trim();
    const audience = (row.dataset.audience || '').trim();
    const message = (cols[3]?.innerText || '').replace(/\s+/g,' ').trim();
    const scheduled = (cols[4]?.innerText || '').trim();
    const progressCell = cols[5];
    const progressText = progressCell?.innerText.replace('%','').trim() || '';
    const sentMatch = progressCell?.querySelector('.progress')?.getAttribute('title') || '';
    const sent = (sentMatch.match(/–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ:\s*(\d+)/) || [])[1] || '';
    const total = (sentMatch.match(/–∏–∑\s*(\d+)/) || [])[1] || '';
    
    const line = [id,status,audience,message,scheduled,sent,total,progressText]
      .map(val => `"${String(val).replace(/"/g,'""')}"`)
      .join(',');
    lines.push(line);
  });
  
  const blob = new Blob([lines.join('\n')], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const link = document.createElement('a');
  link.href = url;
  link.download = `broadcasts_${new Date().toISOString().slice(0,10)}.csv`;
  link.click();
  URL.revokeObjectURL(url);
}
</script>