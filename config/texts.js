// config/texts.js

import { supabase } from '../db.js';

// --- –°–∏—Å—Ç–µ–º–Ω—ã–µ –∫–ª—é—á–∏, –∫–æ—Ç–æ—Ä—ã–µ –ù–ï–õ–¨–ó–Ø —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –≤ –∞–¥–º–∏–Ω–∫–µ ---
const systemKeys = {
  menu: 'üìã –ú–µ–Ω—é',
  upgrade: 'üîì –†–∞—Å—à–∏—Ä–∏—Ç—å –ª–∏–º–∏—Ç',
  mytracks: 'üéµ –ú–æ–∏ —Ç—Ä–µ–∫–∏',
  help: '‚ÑπÔ∏è –ü–æ–º–æ—â—å',
};

// --- –¢–µ–∫—Å—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ –ú–û–ñ–ù–û —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –≤ –∞–¥–º–∏–Ω–∫–µ ---
const editableTexts = {
  // –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è
  start: 'üëã –°–Ω–æ–≤–∞ –∑–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –ü—Ä–∏—à–ª–∏—Ç–µ —Å—Å—ã–ª–∫—É –Ω–∞ —Ç—Ä–µ–∫.', 
  start_new_user: 
    `<b>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ SCloudMusicBot!</b>\n\n` +
    `–Ø –ø–æ–º–æ–≥—É –≤–∞–º —Å–∫–∞—á–∞—Ç—å –ª—é–±–∏–º—ã–µ —Ç—Ä–µ–∫–∏ –∏ <b>–ø–ª–µ–π–ª–∏—Å—Ç—ã</b> —Å SoundCloud –≤ MP3.\n\n` +
    `<b>–ú–æ–∏ –≥–ª–∞–≤–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:</b>\n\n` +
    `üì• <b>1. –°–∫–∞—á–∏–≤–∞–Ω–∏–µ –ø–æ —Å—Å—ã–ª–∫–µ</b>\n` +
    `–ü—Ä–æ—Å—Ç–æ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –º–Ω–µ —Å—Å—ã–ª–∫—É –Ω–∞ —Ç—Ä–µ–∫ –∏–ª–∏ —Ü–µ–ª—ã–π –ø–ª–µ–π–ª–∏—Å—Ç, –∏ —è –Ω–∞—á–Ω—É –∑–∞–≥—Ä—É–∑–∫—É.\n\n` +
    `üîé <b>2. –ü–æ–∏—Å–∫ –º—É–∑—ã–∫–∏ –ø—Ä—è–º–æ –≤ —á–∞—Ç–µ</b>\n` +
    `–í –ª—é–±–æ–º –¥—Ä—É–≥–æ–º —á–∞—Ç–µ (–∏–ª–∏ –∑–¥–µ—Å—å) –Ω–∞—á–Ω–∏—Ç–µ –≤–≤–æ–¥–∏—Ç—å <code>@SCloudMusicBot</code> –∏ —á–µ—Ä–µ–∑ –ø—Ä–æ–±–µ–ª –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç—Ä–µ–∫–∞. –í—ã —Å–º–æ–∂–µ—Ç–µ –Ω–∞–π—Ç–∏ –∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –º—É–∑—ã–∫—É, –Ω–µ –≤—ã—Ö–æ–¥—è –∏–∑ –ø–µ—Ä–µ–ø–∏—Å–∫–∏ –≤ –ª—é–±–æ–º —á–∞—Ç–µ!`,

  // –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç–∞—Ä–∏—Ñ–∞—Ö –∏ –ø–æ–º–æ—â—å
  upgradeInfo:
    `<b>üöÄ –•–æ—á–µ—à—å –±–æ–ª—å—à–µ —Ç—Ä–µ–∫–æ–≤?</b>\n\n` +
    `<b>üÜì Free</b> ‚Äî 5 üü¢\n` +
    `<b>üéØ Plus</b> ‚Äî 30 (119‚ÇΩ)\n` +
    `<b>üí™ Pro</b> ‚Äî 100 (199‚ÇΩ)\n` +
    `<b>üíé Unlimited</b> ‚Äî –±–µ–∑–ª–∏–º–∏—Ç (299‚ÇΩ)\n\n` +
    `üëâ –î–æ–Ω–∞—Ç: <a href="https://boosty.to/anatoly_bone/donate">boosty.to/anatoly_bone/donate</a>\n` +
    `‚úâÔ∏è –ü–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã –Ω–∞–ø–∏—à–∏: @anatolybone\n\n` +
    `üì£ –ù–æ–≤–æ—Å—Ç–∏ –∏ —Ñ–∏—à–∫–∏: @SCMBLOG`,
  helpInfo:
    '‚ÑπÔ∏è –ü—Ä–∏—à–ª–∏ —Å—Å—ã–ª–∫—É ‚Äî –ø–æ–ª—É—á–∏—à—å mp3.\n' +
    'üîì ¬´–†–∞—Å—à–∏—Ä–∏—Ç—å¬ª ‚Äî –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç–∞—Ä–∏—Ñ–∞—Ö.\n' +
    'üéµ ¬´–ú–æ–∏ —Ç—Ä–µ–∫–∏¬ª ‚Äî —Å–ø–∏—Å–æ–∫ –∑–∞ —Å–µ–≥–æ–¥–Ω—è.\n' +
    'üì£ –ö–∞–Ω–∞–ª: @SCM_BLOG',

  // –®–∞–±–ª–æ–Ω—ã –¥–ª—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–≥–æ –º–µ–Ω—é
  menu_header: 'üëã –ü—Ä–∏–≤–µ—Ç, {first_name}!\n<b>–¢–≤–æ–π –ø—Ä–æ—Ñ–∏–ª—å:</b>',
  menu_referral_block: 'üôã‚Äç‚ôÇÔ∏è <b>–ü—Ä–∏–≥–ª–∞—à–µ–Ω–æ –¥—Ä—É–∑–µ–π:</b> <i>{referral_count}</i>\nüîó <b>–¢–≤–æ—è —Å—Å—ã–ª–∫–∞ –¥–ª—è –±–æ–Ω—É—Å–æ–≤:</b>\n<code>{referral_link}</code>',
  menu_bonus_block: 'üéÅ <b>–ë–æ–Ω—É—Å!</b> –ü–æ–¥–ø–∏—à–∏—Å—å –Ω–∞ {channel_link} –∏ –ø–æ–ª—É—á–∏ <b>+7 –¥–Ω–µ–π —Ç–∞—Ä–∏—Ñ–∞ Plus</b> –±–µ—Å–ø–ª–∞—Ç–Ω–æ!',
  menu_footer: '–ü—Ä–æ—Å—Ç–æ –æ—Ç–ø—Ä–∞–≤—å –º–Ω–µ —Å—Å—ã–ª–∫—É, –∏ —è —Å–∫–∞—á–∞—é —Ç—Ä–µ–∫!',

  // –°–∏—Å—Ç–µ–º–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
  error: '‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –Ω–µ–ø—Ä–µ–¥–≤–∏–¥–µ–Ω–Ω–∞—è –æ—à–∏–±–∫–∞.',
  noTracks: '–í—ã –µ—â–µ –Ω–µ —Å–∫–∞—á–∏–≤–∞–ª–∏ —Ç—Ä–µ–∫–æ–≤ —Å–µ–≥–æ–¥–Ω—è.',
  limitReached: 'üö´ –î–Ω–µ–≤–Ω–æ–π –ª–∏–º–∏—Ç –∑–∞–≥—Ä—É–∑–æ–∫ –∏—Å—á–µ—Ä–ø–∞–Ω.',
  blockedMessage: '‚ùå –í–∞—à –∞–∫–∫–∞—É–Ω—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º.',

  // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ–± –∏—Å—Ç–µ—á–µ–Ω–∏–∏ –ø–æ–¥–ø–∏—Å–∫–∏ (–∏—Å–ø–æ–ª—å–∑—É–µ–º –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä—ã: {name}, {days}, {days_word})
  exp_3d: 'üëã –ü—Ä–∏–≤–µ—Ç, {name}!\n–í–∞—à–∞ –ø–æ–¥–ø–∏—Å–∫–∞ –∏—Å—Ç–µ–∫–∞–µ—Ç —á–µ—Ä–µ–∑ {days} {days_word}.\n–ù–µ –∑–∞–±—É–¥—å—Ç–µ –ø—Ä–æ–¥–ª–∏—Ç—å –µ—ë, —á—Ç–æ–±—ã —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫–æ –≤—Å–µ–º –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—è–º!\n\n–ù–∞–∂–º–∏—Ç–µ /premium, —á—Ç–æ–±—ã –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Ç–∞—Ä–∏—Ñ—ã.',
  exp_1d: 'üëã –ü—Ä–∏–≤–µ—Ç, {name}!\n–í–∞—à–∞ –ø–æ–¥–ø–∏—Å–∫–∞ –∏—Å—Ç–µ–∫–∞–µ—Ç –∑–∞–≤—Ç—Ä–∞.\n–ü—Ä–æ–¥–ª–∏—Ç–µ –∑–∞—Ä–∞–Ω–µ–µ, —á—Ç–æ–±—ã –Ω–µ –ø–æ—Ç–µ—Ä—è—Ç—å –¥–æ—Å—Ç—É–ø. –ù–∞–∂–º–∏—Ç–µ /premium.',
  exp_0d: '‚ö†Ô∏è –ü—Ä–∏–≤–µ—Ç, {name}!\n–í–∞—à–∞ –ø–æ–¥–ø–∏—Å–∫–∞ –∏—Å—Ç–µ–∫–∞–µ—Ç —Å–µ–≥–æ–¥–Ω—è.\n–ü—Ä–æ–¥–ª–∏—Ç–µ —Å–µ–π—á–∞—Å: /premium',
};

// --- –í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –ª–æ–≥–∏–∫–∞ (–æ—Å—Ç–∞–µ—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) ---

const defaults = { ...systemKeys, ...editableTexts };

export function getEditableTexts() {
  const currentTexts = allTextsSync();
  const result = {};
  for (const key in editableTexts) {
    result[key] = currentTexts[key] ?? editableTexts[key];
  }
  return result;
}

let cache = { ...defaults };
let lastLoad = 0;
const TTL_MS = 60 * 1000;

export async function loadTexts(force = false) {
  const now = Date.now();
  if (!force && now - lastLoad < TTL_MS) return cache;
  try {
    const { data, error } = await supabase.from('bot_texts').select('key,value');
    if (error) {
      console.error('[texts] –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑ Supabase:', error.message);
      return cache;
    }
    const map = { ...defaults };
    for (const row of data || []) {
      if (row?.key && typeof row.value === 'string') map[row.key] = row.value;
    }
    cache = map;
    lastLoad = now;
  } catch (e) {
    console.error('[texts] –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ç–µ–∫—Å—Ç–æ–≤:', e.message);
  }
  return cache;
}

export function T(key) {
  return cache[key] ?? defaults[key] ?? '';
}

export function allTextsSync() {
  return { ...cache };
}

export async function setText(key, value) {
  if (!key) throw new Error('key is required');
  const { error } = await supabase
    .from('bot_texts')
    .upsert({ key, value }, { onConflict: 'key' });
  if (error) throw new Error(error.message);
  cache[key] = value;
  lastLoad = 0;
  return true;
}

// –ü–æ–¥—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä–æ–≤ {name}, {days}, {days_word} –∏ —Ç.–¥.
export function Tf(key, params = {}) {
  const s = T(key) || '';
  return s.replace(/\{(\w+)\}/g, (_, k) => (params[k] ?? ''));
}