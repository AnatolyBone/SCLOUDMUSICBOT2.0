<%# views/partials/users-table.ejs (–±–µ–∑–æ–ø–∞—Å–Ω–∞—è —Ñ–∏–Ω–∞–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è) %>

<div class="table-responsive">
  <table class="table table-striped table-hover align-middle">
    <thead class="table-light">
      <tr>
        <%# === –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å—Å—ã–ª–æ–∫ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ === %>
        <% 
        function sortLink(field, title) { 
          const params = new URLSearchParams();
          // –ë–µ–∑–æ–ø–∞—Å–Ω–æ –∫–æ–ø–∏—Ä—É–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
          if (queryParams) {
            Object.keys(queryParams).forEach(k => {
              if (k !== 'page') params.set(k, queryParams[k]); // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ø–∞–≥–∏–Ω–∞—Ü–∏—é –ø—Ä–∏ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–µ
            });
          }
          
          const isCurrent = (queryParams?.sort === field);
          const nextOrder = (isCurrent && queryParams?.order === 'asc') ? 'desc' : 'asc';
          params.set('sort', field);
          params.set('order', nextOrder);
          params.set('page', 1); // –í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –Ω–∞ –ø–µ—Ä–≤—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É
          
          const icon = isCurrent 
            ? (queryParams?.order === 'asc' ? '‚Üë' : '‚Üì')
            : '';
        %>
          <th scope="col" class="text-nowrap">
            <a href="/users-table?<%= params.toString() %>"
               hx-get="/users-table?<%= params.toString() %>"
               hx-include="#usersFilterForm"
               hx-target="#users-table-container"
               hx-swap="innerHTML"
               class="text-decoration-none text-body fw-semibold">
              <%= title %> <% if (icon) { %><span class="text-primary"><%= icon %></span><% } %>
            </a>
          </th>
        <% } %>

        <%- sortLink('id', 'ID') %>
        <th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th>
        <%- sortLink('active', '–°—Ç–∞—Ç—É—Å') %>
        <%- sortLink('total_downloads', '–ó–∞–≥—Ä—É–∑–æ–∫') %>
        <%- sortLink('premium_limit', '–¢–∞—Ä–∏—Ñ') %>
        <%- sortLink('premium_until', '–ü—Ä–µ–º–∏—É–º –¥–æ') %>
        <%- sortLink('created_at', '–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è') %>
        <%- sortLink('last_active', '–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å') %>
        <th>–°–º–µ–Ω–∞ —Ç–∞—Ä–∏—Ñ–∞</th>
        <th class="text-center">–î–µ–π—Å—Ç–≤–∏—è</th>
      </tr>
    </thead>

    <tbody>
      <% if (users && users.length > 0) { %>
        <% users.forEach(u => { 
            // === 1. –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ ===
            const escapeHtml = (str) => {
              if (!str) return '';
              return String(str).replace(/[&<>"']/g, (m) => ({
                '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;'
              })[m]);
            };
            
            const safeName = escapeHtml(u.first_name) || '–ë–µ–∑ –∏–º–µ–Ω–∏';
            const safeUsername = u.username ? '@' + escapeHtml(u.username) : '';
            
            // === 2. –õ–û–ì–ò–ö–ê –¢–ê–†–ò–§–û–í (–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–∞—è) ===
            const now = new Date();
            const until = u.premium_until ? new Date(u.premium_until) : null;
            const isActive = until && until > now; 
            const limit = u.premium_limit || 5;

            let plan = 'Free';
            let planBadge = 'bg-secondary';

            if (isActive) {
                // –ï—Å–ª–∏ –ø–æ–¥–ø–∏—Å–∫–∞ –ê–ö–¢–ò–í–ù–ê
                if (limit >= 10000) { plan = 'üíé Unlim'; planBadge = 'bg-primary'; }
                else if (limit >= 100) { plan = 'üí™ Pro'; planBadge = 'bg-warning text-dark'; }
                else if (limit >= 30) { plan = 'üéØ Plus'; planBadge = 'bg-info text-dark'; }
                else { plan = 'Premium'; planBadge = 'bg-success'; }
            } else {
                // –ï—Å–ª–∏ –ø–æ–¥–ø–∏—Å–∫–∞ –ù–ï–ê–ö–¢–ò–í–ù–ê
                if (limit > 10) { 
                    // –õ–∏–º–∏—Ç –≤—ã—Å–æ–∫–∏–π, –Ω–æ –≤—Ä–µ–º—è –≤—ã—à–ª–æ = –ò—Å—Ç—ë–∫
                    plan = '‚åõ –ò—Å—Ç—ë–∫'; 
                    planBadge = 'bg-danger'; 
                } else {
                    // –û–±—ã—á–Ω—ã–π Free
                    plan = 'Free'; 
                    planBadge = 'bg-secondary';
                }
            }

            // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞—Ç
            const formatDate = (date) => date ? new Date(date).toLocaleDateString('ru-RU', {day:'2-digit',month:'2-digit',year:'2-digit'}) : '‚Äî';
            const formatDateTime = (date) => date ? new Date(date).toLocaleString('ru-RU', {day:'2-digit',month:'2-digit',hour:'2-digit',minute:'2-digit'}) : '‚Äî';
        %>
          <tr>
            <%# === ID === %>
            <td data-label="ID"><a href="/user/<%= u.id %>" class="text-decoration-none font-monospace"><%= u.id %></a></td>

            <%# === –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å === %>
            <td data-label="–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å">
              <div class="fw-bold"><%- safeName %></div>
              <% if (safeUsername) { %><div class="text-muted small"><%- safeUsername %></div><% } %>
            </td>

            <%# === –°—Ç–∞—Ç—É—Å === %>
            <td data-label="–°—Ç–∞—Ç—É—Å">
              <% if (u.active) { %>
                <span class="badge bg-success">‚úì –ê–∫—Ç–∏–≤–µ–Ω</span>
              <% } else { %>
                <span class="badge bg-danger">‚úï –ë–ª–æ–∫</span>
              <% } %>
            </td>

            <%# === –ó–∞–≥—Ä—É–∑–æ–∫ === %>
            <td data-label="–ó–∞–≥—Ä—É–∑–æ–∫" class="text-center">
              <span class="badge bg-light text-dark border"><%= u.total_downloads || 0 %></span>
            </td>

            <%# === –¢–∞—Ä–∏—Ñ (–ë–µ–π–¥–∂–∏–∫) === %>
            <td data-label="–¢–∞—Ä–∏—Ñ" class="text-center">
              <span class="badge <%= planBadge %>"><%= plan %></span>
            </td>

            <%# === –ü—Ä–µ–º–∏—É–º –¥–æ === %>
            <td data-label="–ü—Ä–µ–º–∏—É–º –¥–æ" class="text-nowrap small">
              <% if (isActive) { %>
                <span class="text-success fw-bold"><%= formatDateTime(until) %></span>
              <% } else if (until) { %>
                <span class="text-muted text-decoration-line-through"><%= formatDateTime(until) %></span>
              <% } else { %>
                <span class="text-muted">‚Äî</span>
              <% } %>
            </td>

            <%# === –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è === %>
            <td data-label="–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è" class="text-nowrap small text-muted"><%= formatDate(u.created_at) %></td>

            <%# === –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å === %>
            <td data-label="–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å" class="text-nowrap small text-muted"><%= formatDateTime(u.last_active) %></td>

            <%# === –°–º–µ–Ω–∞ —Ç–∞—Ä–∏—Ñ–∞ (–§–æ—Ä–º–∞) === %>
            <td data-label="–°–º–µ–Ω–∞ —Ç–∞—Ä–∏—Ñ–∞">
              <form class="d-flex gap-1 align-items-center tariff-form" action="/set-tariff" method="post">
                <input type="hidden" name="userId" value="<%= u.id %>">
                <input type="hidden" name="applyMode" value="set">
                
                <select name="limit" class="form-select form-select-sm" style="width: 100px;" required>
                  <option value="5"     <%= limit <= 5 ? 'selected' : '' %>>Free</option>
                  <option value="30"    <%= limit === 30 ? 'selected' : '' %>>Plus</option>
                  <option value="100"   <%= limit === 100 ? 'selected' : '' %>>Pro</option>
                  <option value="10000" <%= limit >= 10000 ? 'selected' : '' %>>Unlim</option>
                </select>
                
                <input type="number" name="days" class="form-control form-control-sm" value="30" style="width: 60px;" placeholder="–î–Ω–∏">
                
                <button type="submit" class="btn btn-sm btn-primary px-2">‚úì</button>
              </form>
            </td>

            <%# === –ú–µ–Ω—é –¥–µ–π—Å—Ç–≤–∏–π === %>
            <td data-label="–î–µ–π—Å—Ç–≤–∏—è" class="text-center">
               <!-- –¢–≤–æ–π —Å—Ç–∞—Ä—ã–π –∫–æ–¥ –¥—Ä–æ–ø–¥–∞—É–Ω–∞ (–º–æ–∂–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å –∫–∞–∫ –µ—Å—Ç—å –≤ —Ç–≤–æ–µ–º —Ñ–∞–π–ª–µ, –∏–ª–∏ —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –Ω–∏–∂–µ) -->
               <div class="btn-group">
                <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="dropdown">‚ãÆ</button>
                <ul class="dropdown-menu dropdown-menu-end">
                  <li><a class="dropdown-item" href="/user/<%= u.id %>">üë§ –ü—Ä–æ—Ñ–∏–ª—å</a></li>
                  <li><hr class="dropdown-divider"></li>
                  <li>
                    <form action="/user/set-status" method="POST">
                      <input type="hidden" name="userId" value="<%= u.id %>">
                      <input type="hidden" name="newStatus" value="<%= !u.active %>">
                      <button type="submit" class="dropdown-item <%= u.active ? 'text-danger' : 'text-success' %>">
                        <%= u.active ? '–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å' : '–†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å' %>
                      </button>
                    </form>
                  </li>
                </ul>
              </div>
            </td>
          </tr>
        <% }) %>
      <% } else { %>
        <tr><td colspan="10" class="text-center py-5 text-muted">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</td></tr>
      <% } %>

<%# === PAGINATION (Safe Version) === %>
<% if (typeof totalPages !== 'undefined' && totalPages > 0) { 
  const curr = typeof queryParams !== 'undefined' ? Number(queryParams.page || 1) : 1;
  
  function buildPageUrl(pageNum) {
    const params = new URLSearchParams();
    if (typeof queryParams !== 'undefined') {
      Object.keys(queryParams).forEach(k => params.set(k, queryParams[k]));
    }
    params.set('page', pageNum);
    return '/users-table?' + params.toString();
  }
%>
<nav aria-label="–ù–∞–≤–∏–≥–∞—Ü–∏—è">
  <ul class="pagination justify-content-center mt-4 pagination-sm">
    
    <%# –ö–Ω–æ–ø–∫–∞ –ù–∞–∑–∞–¥ %>
    <li class="page-item <%= (curr <= 1) ? 'disabled' : '' %>">
      <% if (curr > 1) { %>
        <a class="page-link" href="<%= buildPageUrl(curr - 1) %>" 
           hx-get="<%= buildPageUrl(curr - 1) %>" hx-include="#usersFilterForm" hx-target="#users-table-container">
           &laquo;
        </a>
      <% } else { %>
        <span class="page-link">&laquo;</span>
      <% } %>
    </li>

    <%# –¢–µ–∫—É—â–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ %>
    <li class="page-item active">
      <span class="page-link"><%= curr %> / <%= totalPages %></span>
    </li>

    <%# –ö–Ω–æ–ø–∫–∞ –í–ø–µ—Ä–µ–¥ %>
    <li class="page-item <%= (curr >= totalPages) ? 'disabled' : '' %>">
      <% if (curr < totalPages) { %>
        <a class="page-link" href="<%= buildPageUrl(curr + 1) %>"
           hx-get="<%= buildPageUrl(curr + 1) %>" hx-include="#usersFilterForm" hx-target="#users-table-container">
           &raquo;
        </a>
      <% } else { %>
        <span class="page-link">&raquo;</span>
      <% } %>
    </li>
  </ul>
  
  <%# –ò–ù–§–û–†–ú–ê–¶–ò–Ø (–ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –°–¢–†–û–ö–ê) %>
  <div class="text-center text-muted small mt-2">
    <% if (typeof totalUsers !== 'undefined' && totalUsers !== null) { %>
      (–≤—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: <strong><%= totalUsers.toLocaleString('ru-RU') %></strong>)
    <% } else { %>
      –°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    <% } %>
  </div>
</nav>
<% } %>

<%# === –°–ö–†–ò–ü–¢ –î–õ–Ø –£–õ–£–ß–®–ï–ù–ò–Ø UX === %>
<script>
// –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏–π (–µ—Å–ª–∏ admin.js –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω)
if (typeof window.adminScriptLoaded === 'undefined') {
  document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('[data-confirm]').forEach(el => {
      el.addEventListener('click', (e) => {
        const message = el.dataset.confirm || '–í—ã —É–≤–µ—Ä–µ–Ω—ã?';
        if (!confirm(message)) {
          e.preventDefault();
        }
      });
    });
  });
}

// –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ HTMX
document.body.addEventListener('htmx:beforeRequest', () => {
  const container = document.getElementById('users-table-container');
  if (container) {
    container.style.opacity = '0.6';
    container.style.pointerEvents = 'none';
  }
});

document.body.addEventListener('htmx:afterRequest', () => {
  const container = document.getElementById('users-table-container');
  if (container) {
    container.style.opacity = '1';
    container.style.pointerEvents = 'auto';
  }
});

// –ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–∏ —Å–∫—Ä–æ–ª–ª–∞
document.body.addEventListener('htmx:beforeSwap', () => {
  sessionStorage.setItem('usersTableScroll', window.scrollY);
});

document.body.addEventListener('htmx:afterSettle', () => {
  const scrollPos = sessionStorage.getItem('usersTableScroll');
  if (scrollPos) {
    window.scrollTo(0, parseInt(scrollPos, 10));
  }
});

// –í–∞–ª–∏–¥–∞—Ü–∏—è —Ñ–æ—Ä–º—ã —Ç–∞—Ä–∏—Ñ–∞
document.addEventListener('submit', (e) => {
  if (e.target.classList.contains('tariff-form')) {
    const daysInput = e.target.querySelector('input[name="days"]');
    const days = parseInt(daysInput.value, 10);
    
    if (isNaN(days) || days < 1 || days > 365) {
      e.preventDefault();
      alert('–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –æ—Ç 1 –¥–æ 365');
      daysInput.focus();
    }
  }
});

// Highlight —Ç–æ–ª—å–∫–æ —á—Ç–æ –æ–±–Ω–æ–≤–ª—ë–Ω–Ω–æ–π —Å—Ç—Ä–æ–∫–∏
if (window.location.hash) {
  const userId = window.location.hash.slice(1);
  const row = document.querySelector(`a[href="/user/${userId}"]`)?.closest('tr');
  if (row) {
    row.style.backgroundColor = 'var(--bs-warning)';
    row.style.transition = 'background-color 2s ease';
    setTimeout(() => {
      row.style.backgroundColor = '';
    }, 2000);
  }
}
</script>
