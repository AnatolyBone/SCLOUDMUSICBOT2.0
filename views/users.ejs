<% // views/users.ejs %>

<%- contentFor('body') %>

<style>
  /* === –ë–ê–ó–û–í–´–ï –°–¢–ò–õ–ò –°–¢–†–ê–ù–ò–¶–´ === */
  .hx-indicator { display: none; }
  .hx-request .hx-indicator { display: inline-block !important; }
  .spinner-sm { width: 1rem; height: 1rem; border-width: .15rem; }
  .form-section-title { font-size: .9rem; color: #6c757d; }

  /* === –ö–ê–†–¢–û–ß–ö–ò –°–¢–ê–¢–ò–°–¢–ò–ö–ò === */
  .stat-card {
    background: var(--bs-card-bg);
    border: 1px solid var(--bs-border-color);
    border-radius: 10px;
    padding: 1rem 1.25rem;
    text-align: center;
    transition: transform 0.15s ease, box-shadow 0.15s ease;
  }
  .stat-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  }
  .stat-card .stat-value {
    font-size: 1.75rem;
    font-weight: 700;
    line-height: 1.2;
  }
  .stat-card .stat-label {
    font-size: 0.8rem;
    color: #6c757d;
    margin-top: 0.25rem;
  }

  /* === –°–¢–ò–õ–ò –¢–ê–ë–õ–ò–¶–´ === */
  .table { font-size: 0.9rem; }
  .table th { font-weight: 600; white-space: nowrap; }
  
  /* –ê–¥–∞–ø—Ç–∏–≤ –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö */
  @media (max-width: 992px) {
    .table thead { display: none; }
    .table tbody tr {
      display: block; margin-bottom: 1rem; border: 1px solid var(--bs-border-color);
      border-radius: 10px; padding: 1rem; background-color: var(--bs-card-bg);
    }
    .table tbody td {
      display: flex; justify-content: space-between; align-items: center;
      padding: 0.5rem 0; border: none; border-bottom: 1px solid var(--bs-border-color);
    }
    .table tbody td:last-child { border-bottom: none; }
    .table tbody td::before {
      content: attr(data-label); font-weight: 600; margin-right: 10px; flex-shrink: 0; color: #6c757d;
    }
    .tariff-form { width: 100%; flex-direction: column; gap: 0.5rem !important; }
    .tariff-form select, .tariff-form input { width: 100% !important; }
    .btn-group { width: 100%; }
    .stat-card .stat-value { font-size: 1.5rem; }
  }

  /* –ê–Ω–∏–º–∞—Ü–∏–∏ */
  .htmx-swapping { opacity: 0; transition: opacity 0.2s ease-out; }
  .badge { font-size: 0.75rem; padding: 4px 8px; font-weight: 600; }

  /* Dropdown */
  .dropdown-menu {
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    border: 1px solid var(--bs-border-color);
    border-radius: 8px;
  }
  .dropdown-item { padding: 8px 14px; transition: background-color 0.15s ease; }
  .dropdown-item:hover { background-color: var(--table-row-hover); }

  /* –§–æ—Ä–º–∞ —Ç–∞—Ä–∏—Ñ–∞ */
  .tariff-form { gap: 6px; }
  .tariff-form .form-select, .tariff-form .form-control { font-size: 0.8rem; padding: 0.25rem 0.5rem; }

  /* –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ */
  thead th a { display: flex; align-items: center; gap: 4px; }
  thead th a:hover { color: var(--bs-primary-color) !important; }

  /* –ü–∞–≥–∏–Ω–∞—Ü–∏—è */
  .pagination { margin-top: 1.5rem; margin-bottom: 1rem; }
  .page-link {
    color: var(--bs-body-color); background-color: var(--bs-card-bg);
    border-color: var(--bs-border-color); transition: all 0.2s ease;
  }
  .page-link:hover {
    color: #ffffff; background-color: var(--bs-primary-color);
    border-color: var(--bs-primary-color);
  }
  .page-item.active .page-link { background-color: var(--bs-primary-color); border-color: var(--bs-primary-color); }
  .page-item.disabled .page-link { background-color: var(--bs-card-bg); border-color: var(--bs-border-color); opacity: 0.5; }
</style>

<script src="https://unpkg.com/htmx.org@1.9.10"></script>

<!-- –î–∞–ª—å—à–µ –∏–¥–µ—Ç –≤–∞—à HTML (div, h1, form...) –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π -->

<div class="d-flex justify-content-between align-items-center mb-4">
  <h1 class="h3 mb-0">üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</h1>
  <div class="hx-indicator">
    <div class="spinner-border text-primary spinner-sm" role="status">
      <span class="visually-hidden">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
    </div>
  </div>
</div>

<!-- –ö–∞—Ä—Ç–æ—á–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ -->
<div class="row g-3 mb-4">
  <div class="col-6 col-md-3">
    <div class="stat-card">
      <div class="stat-value text-primary"><%= typeof totalUsers !== 'undefined' ? totalUsers.toLocaleString('ru-RU') : '‚Äî' %></div>
      <div class="stat-label">–í—Å–µ–≥–æ</div>
    </div>
  </div>
  <div class="col-6 col-md-3">
    <div class="stat-card">
      <div class="stat-value text-success"><%= typeof activeUsers !== 'undefined' ? activeUsers.toLocaleString('ru-RU') : '‚Äî' %></div>
      <div class="stat-label">–ê–∫—Ç–∏–≤–Ω—ã—Ö</div>
    </div>
  </div>
  <div class="col-6 col-md-3">
    <div class="stat-card">
      <div class="stat-value text-warning"><%= typeof premiumUsers !== 'undefined' ? premiumUsers.toLocaleString('ru-RU') : '‚Äî' %></div>
      <div class="stat-label">–ü—Ä–µ–º–∏—É–º</div>
    </div>
  </div>
  <div class="col-6 col-md-3">
    <div class="stat-card">
      <div class="stat-value text-info"><%= typeof newUsersToday !== 'undefined' ? newUsersToday.toLocaleString('ru-RU') : '‚Äî' %></div>
      <div class="stat-label">–ù–æ–≤—ã—Ö —Å–µ–≥–æ–¥–Ω—è</div>
    </div>
  </div>
</div>

<form id="usersFilterForm"
      class="row g-3 align-items-end mb-4"
      hx-get="/users-table"
      hx-target="#users-table-container"
      hx-trigger="keyup changed delay:300ms from:#searchInput, change from:.form-select, change from:.adv-filter"
      hx-swap="innerHTML"
      hx-push-url="true">

  <!-- –ü–æ–∏—Å–∫ / —Å—Ç–∞—Ç—É—Å / –ª–∏–º–∏—Ç / —ç–∫—Å–ø–æ—Ä—Ç -->
  <div class="col-lg-4 col-md-6">
    <label class="form-label form-section-title">–ü–æ–∏—Å–∫</label>
    <input type="text"
           class="form-control"
           id="searchInput"
           name="q"
           placeholder="ID, –∏–º—è, @username..."
           value="<%= typeof searchQuery !== 'undefined' ? searchQuery : (queryParams?.q || '') %>">
  </div>

  <div class="col-lg-2 col-md-6">
    <label class="form-label form-section-title">–°—Ç–∞—Ç—É—Å</label>
    <select class="form-select" name="status">
      <option value="" <%= (statusFilter === '' || (queryParams?.status || '') === '') ? 'selected' : '' %>>–í—Å–µ</option>
      <option value="active"   <%= (statusFilter === 'active' || queryParams?.status === 'active') ? 'selected' : '' %>>–ê–∫—Ç–∏–≤–Ω—ã–µ</option>
      <option value="inactive" <%= (statusFilter === 'inactive' || queryParams?.status === 'inactive') ? 'selected' : '' %>>–ù–µ–∞–∫—Ç–∏–≤–Ω—ã–µ</option>
    </select>
  </div>

  <div class="col-lg-2 col-md-6">
    <label class="form-label form-section-title">–ù–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ</label>
    <select class="form-select" name="limit">
      <option value="25"  <%= (limit == 25  || queryParams?.limit == 25)  ? 'selected' : '' %>>25</option>
      <option value="50"  <%= (limit == 50  || queryParams?.limit == 50)  ? 'selected' : '' %>>50</option>
      <option value="100" <%= (limit == 100 || queryParams?.limit == 100) ? 'selected' : '' %>>100</option>
    </select>
  </div>

  <div class="col-lg-4 col-md-6">
    <label class="form-label form-section-title">–≠–∫—Å–ø–æ—Ä—Ç</label>
    <div class="d-flex gap-2">
      <a id="export-link" href="/users/export.csv" class="btn btn-outline-success w-100">
        <i class="bi bi-file-earmark-spreadsheet"></i> –≠–∫—Å–ø–æ—Ä—Ç –≤ CSV
      </a>
      <button type="button"
              class="btn btn-outline-secondary"
              onclick="resetUsersFilters()">
        –°–±—Ä–æ—Å–∏—Ç—å
      </button>
    </div>
  </div>

  <!-- –¢–∞—Ä–∏—Ñ / –ü—Ä–µ–º–∏—É–º -->
  <div class="col-lg-2 col-md-6">
    <label class="form-label form-section-title">–¢–∞—Ä–∏—Ñ</label>
    <select class="form-select adv-filter" name="tariff">
      <% const tariffSel = queryParams?.tariff || ''; %>
      <option value="" <%= tariffSel === '' ? 'selected' : '' %>>–í—Å–µ</option>
      <option value="Free"      <%= tariffSel === 'Free' ? 'selected' : '' %>>Free (5)</option>
      <option value="Plus"      <%= tariffSel === 'Plus' ? 'selected' : '' %>>Plus (30)</option>
      <option value="Pro"       <%= tariffSel === 'Pro' ? 'selected' : '' %>>Pro (100)</option>
      <option value="Unlimited" <%= tariffSel === 'Unlimited' ? 'selected' : '' %>>Unlim</option>
      <option value="Other"     <%= tariffSel === 'Other' ? 'selected' : '' %>>Other</option>
    </select>
  </div>

  <div class="col-lg-3 col-md-6">
    <label class="form-label form-section-title">–ü—Ä–µ–º–∏—É–º</label>
    <select class="form-select adv-filter" name="premium">
      <% const premiumSel = queryParams?.premium || ''; %>
      <option value=""        <%= premiumSel === '' ? 'selected' : '' %>>–õ—é–±–æ–π</option>
      <option value="active"  <%= premiumSel === 'active' ? 'selected' : '' %>>–ê–∫—Ç–∏–≤–Ω–∞—è –ø—Ä–µ–º–∏—É–º</option>
      <option value="expired" <%= premiumSel === 'expired' ? 'selected' : '' %>>–ò—Å—Ç—ë–∫—à–∞—è –ø—Ä–µ–º–∏—É–º</option>
      <option value="free"    <%= premiumSel === 'free' ? 'selected' : '' %>>–¢–æ–ª—å–∫–æ Free</option>
    </select>
  </div>

  <!-- –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã (collapsible) -->
  <div class="col-12">
    <a class="text-decoration-none" data-bs-toggle="collapse" href="#advancedFilters" role="button" aria-expanded="false" aria-controls="advancedFilters">
      –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã
    </a>
    <div class="collapse mt-3" id="advancedFilters">
      <div class="row g-2">
        <div class="col-md-3">
          <label class="form-label">–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ c</label>
          <input type="date"
                 class="form-control adv-filter"
                 name="created_from"
                 value="<%= queryParams?.created_from || '' %>">
        </div>
        <div class="col-md-3">
          <label class="form-label">–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –ø–æ</label>
          <input type="date"
                 class="form-control adv-filter"
                 name="created_to"
                 value="<%= queryParams?.created_to || '' %>">
        </div>
        <div class="col-md-3">
          <label class="form-label">–ë—ã–ª –∞–∫—Ç–∏–≤–µ–Ω –∑–∞ N –¥–Ω–µ–π</label>
          <input type="number"
                 class="form-control adv-filter"
                 name="active_within_days"
                 min="1"
                 placeholder="7"
                 value="<%= queryParams?.active_within_days || '' %>">
        </div>
        <div class="col-md-3">
          <label class="form-label">–ò—Å—Ç–æ—á–Ω–∏–∫ —Ç—Ä–∞—Ñ–∏–∫–∞</label>
          <input type="text"
                 class="form-control adv-filter"
                 name="ref_source"
                 placeholder="utm / –∫–ª—é—á–µ–≤–æ–µ..."
                 value="<%= queryParams?.ref_source || '' %>">
        </div>
        <div class="col-md-3">
          <label class="form-label">–†–µ—Ñ–µ—Ä–µ—Ä</label>
          <select class="form-select adv-filter" name="has_referrer">
            <% const hasRef = queryParams?.has_referrer || ''; %>
            <option value=""   <%= hasRef === '' ? 'selected' : '' %>>–õ—é–±–æ–π</option>
            <option value="yes"<%= hasRef === 'yes' ? 'selected' : '' %>>–° —Ä–µ—Ñ–µ—Ä–µ—Ä–æ–º</option>
            <option value="no" <%= hasRef === 'no' ? 'selected' : '' %>>–ë–µ–∑ —Ä–µ—Ñ–µ—Ä–µ—Ä–∞</option>
          </select>
        </div>
        <div class="col-md-3">
          <label class="form-label">–°–∫–∞—á–∏–≤–∞–Ω–∏–π ‚â•</label>
          <input type="number"
                 class="form-control adv-filter"
                 name="downloads_min"
                 min="0"
                 placeholder="1"
                 value="<%= queryParams?.downloads_min || '' %>">
        </div>
      </div>
    </div>
  </div>
</form>

<!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –∂–∏–≤–æ–π –ø–æ–¥—Å—Ç–∞–Ω–æ–≤–∫–∏ —Ç–∞–±–ª–∏—Ü—ã -->
<div id="users-table-container">
  <%- include('partials/users-table', {
        users,
        totalPages,
        currentPage,
        queryParams
      }) %>
</div>

<script>
  // 1. –§—É–Ω–∫—Ü–∏—è —Å–±–æ—Ä–∞ —Ñ–∏–ª—å—Ç—Ä–æ–≤ –¥–ª—è CSV
  function collectFilters() {
    const form = document.getElementById('usersFilterForm');
    if (!form) return {};
    const data = new FormData(form);
    const params = new URLSearchParams();

    const fields = [
      'q','status','limit','tariff','premium',
      'created_from','created_to','active_within_days',
      'ref_source','has_referrer','downloads_min'
    ];
    fields.forEach(k => {
      const v = data.get(k);
      if (v !== null && v !== '') params.set(k, v);
    });
    return params;
  }

  // 2. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Å—ã–ª–∫–∏ —ç–∫—Å–ø–æ—Ä—Ç–∞
  function updateExportLink() {
    const exportLink = document.getElementById('export-link');
    if (!exportLink) return;
    const params = collectFilters();
    const qs = params.toString();
    exportLink.href = qs ? `/users/export.csv?${qs}` : '/users/export.csv';
  }

  function resetUsersFilters() {
    const form = document.getElementById('usersFilterForm');
    if (!form) return;
    form.reset();
    htmx.trigger(form, 'change');
    updateExportLink();
  }

  // –ü—Ä–∏ –ø–µ—Ä–≤–æ–π –∑–∞–≥—Ä—É–∑–∫–µ
  document.addEventListener('DOMContentLoaded', updateExportLink);

  // === –ì–õ–ê–í–ù–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï ===
  // –°–ª—É—à–∞–µ–º —Å–æ–±—ã—Ç–∏–µ HTMX –ø–æ—Å–ª–µ —Ç–æ–≥–æ, –∫–∞–∫ –∫–æ–Ω—Ç–µ–Ω—Ç –±—ã–ª –∑–∞–º–µ–Ω–µ–Ω (afterSwap)
  document.addEventListener('htmx:afterSwap', function(event) {
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –æ–±–Ω–æ–≤–∏–ª—Å—è –∏–º–µ–Ω–Ω–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Ç–∞–±–ª–∏—Ü—ã
    if (event.detail.target.id === 'users-table-container') {
      console.log('HTMX: –¢–∞–±–ª–∏—Ü–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞, –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º Bootstrap –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã...');

      // 1. –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º Dropdowns (–≤—ã–ø–∞–¥–∞—é—â–∏–µ –º–µ–Ω—é –≤ "–î–µ–π—Å—Ç–≤–∏—è—Ö")
      // –ò—â–µ–º –≤—Å–µ —ç–ª–µ–º–µ–Ω—Ç—ã —Å data-bs-toggle="dropdown" –≤–Ω—É—Ç—Ä–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
      var dropdowns = event.detail.target.querySelectorAll('[data-bs-toggle="dropdown"]');
      dropdowns.forEach(function (el) {
        new bootstrap.Dropdown(el);
      });

      // 2. –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º Tooltips (–≤—Å–ø–ª—ã–≤–∞—é—â–∏–µ –ø–æ–¥—Å–∫–∞–∑–∫–∏), –µ—Å–ª–∏ –µ—Å—Ç—å
      var tooltips = event.detail.target.querySelectorAll('[data-bs-toggle="tooltip"]');
      tooltips.forEach(function (el) {
        new bootstrap.Tooltip(el);
      });
    }
  });

  // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Å—ã–ª–∫—É —ç–∫—Å–ø–æ—Ä—Ç–∞ –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–∞
  document.body.addEventListener('htmx:afterSettle', function (evt) {
    const form = document.getElementById('usersFilterForm');
    if (evt?.detail?.elt === form || evt?.target?.id === 'usersFilterForm') {
      updateExportLink();
    }
  });
</script>
