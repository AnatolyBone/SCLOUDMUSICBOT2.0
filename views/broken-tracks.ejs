<!-- views/broken-tracks.ejs -->

<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
  <h1 class="h2">üö® –ü—Ä–æ–±–ª–µ–º–Ω—ã–µ —Ç—Ä–µ–∫–∏</h1>
  <div class="btn-toolbar mb-2 mb-md-0 gap-2">
    <button type="button" class="btn btn-sm btn-outline-danger" id="deleteSelectedBtn" disabled onclick="deleteSelected()">
      üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ (<span id="selectedCount">0</span>)
    </button>
    <button type="button" class="btn btn-sm btn-outline-primary" onclick="exportCSV()">
      üì• –≠–∫—Å–ø–æ—Ä—Ç CSV
    </button>
    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="location.reload()">
      üîÑ –û–±–Ω–æ–≤–∏—Ç—å
    </button>
  </div>
</div>

<!-- üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
<% if (tracks && tracks.length > 0) { %>
<div class="row mb-4">
  <div class="col-md-3 col-6 mb-2">
    <div class="card bg-danger text-white">
      <div class="card-body text-center py-3">
        <h3 class="mb-0"><%= totalTracks || 0 %></h3>
        <small>–í—Å–µ–≥–æ –ø—Ä–æ–±–ª–µ–º</small>
      </div>
    </div>
  </div>
  <div class="col-md-3 col-6 mb-2">
    <div class="card bg-warning text-dark">
      <div class="card-body text-center py-3">
        <h3 class="mb-0"><%= tracks.filter(t => t.reason === 'download_failed').length %></h3>
        <small>–û—à–∏–±–∫–∏ –∑–∞–≥—Ä—É–∑–∫–∏</small>
      </div>
    </div>
  </div>
  <div class="col-md-3 col-6 mb-2">
    <div class="card bg-info text-white">
      <div class="card-body text-center py-3">
        <h3 class="mb-0"><%= tracks.filter(t => t.reason === 'not_found').length %></h3>
        <small>–ù–µ –Ω–∞–π–¥–µ–Ω–æ</small>
      </div>
    </div>
  </div>
  <div class="col-md-3 col-6 mb-2">
    <div class="card bg-secondary text-white">
      <div class="card-body text-center py-3">
        <h3 class="mb-0"><%= [...new Set(tracks.map(t => t.user_id))].length %></h3>
        <small>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</small>
      </div>
    </div>
  </div>
</div>

<!-- üîç –§–∏–ª—å—Ç—Ä—ã -->
<div class="card mb-4">
  <div class="card-body">
    <div class="row g-3">
      <div class="col-md-4">
        <label class="form-label">üîé –ü–æ–∏—Å–∫</label>
        <input type="text" class="form-control" id="searchInput" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Ç—Ä–µ–∫–∞ –∏–ª–∏ URL..." onkeyup="filterTable()">
      </div>
      <div class="col-md-3">
        <label class="form-label">‚ö†Ô∏è –¢–∏–ø –æ—à–∏–±–∫–∏</label>
        <select class="form-select" id="reasonFilter" onchange="filterTable()">
          <option value="">–í—Å–µ –æ—à–∏–±–∫–∏</option>
          <option value="PREVIEW_ONLY">–¢–æ–ª—å–∫–æ –ø—Ä–µ–≤—å—é (SC/YTDL)</option>
          <option value="FILE_TOO_LARGE">–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π</option>
          <option value="403_FORBIDDEN">–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â—ë–Ω (403)</option>
          <option value="RATE_LIMIT">–õ–∏–º–∏—Ç –∑–∞–ø—Ä–æ—Å–æ–≤ (429)</option>
          <option value="DOWNLOAD_ERROR">–û—à–∏–±–∫–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è</option>
          <option value="UNKNOWN_ERROR">–î—Ä—É–≥–∞—è –æ—à–∏–±–∫–∞</option>
        </select>
      </div>
      <div class="col-md-3">
        <label class="form-label">üìÖ –ü–µ—Ä–∏–æ–¥</label>
        <select class="form-select" id="dateFilter" onchange="filterTable()">
          <option value="">–í—Å–µ –≤—Ä–µ–º—è</option>
          <option value="today">–°–µ–≥–æ–¥–Ω—è</option>
          <option value="week">–ó–∞ –Ω–µ–¥–µ–ª—é</option>
          <option value="month">–ó–∞ –º–µ—Å—è—Ü</option>
        </select>
      </div>
      <div class="col-md-2 d-flex align-items-end">
        <button class="btn btn-outline-secondary w-100" onclick="clearFilters()">–°–±—Ä–æ—Å–∏—Ç—å</button>
      </div>
    </div>
  </div>
</div>
<% } %>

<% if (!tracks || tracks.length === 0) { %>
  <div class="alert alert-success d-flex align-items-center" role="alert">
    <span style="font-size: 3rem; margin-right: 1rem;">üéâ</span>
    <div>
      <h4 class="alert-heading mb-1">–û—Ç–ª–∏—á–Ω–æ!</h4>
      <p class="mb-0">–ü—Ä–æ–±–ª–µ–º–Ω—ã—Ö —Ç—Ä–µ–∫–æ–≤ –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ. –í—Å–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–∞–∫ —á–∞—Å—ã!</p>
    </div>
  </div>
<% } else { %>
  <!-- üìã –¢–∞–±–ª–∏—Ü–∞ -->
  <div class="table-responsive">
    <table class="table table-striped table-hover" id="tracksTable">
      <thead class="table-dark">
        <tr>
          <th width="40">
            <input type="checkbox" class="form-check-input" id="selectAll" onclick="toggleSelectAll()">
          </th>
          <th style="cursor: pointer" onclick="sortTable(0)">–î–∞—Ç–∞ ‚áÖ</th>
          <th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th>
          <th style="cursor: pointer" onclick="sortTable(2)">–¢—Ä–µ–∫ ‚áÖ</th>
          <th>–û—à–∏–±–∫–∞</th>
          <th>–°—Å—ã–ª–∫–∞</th>
          <th width="150">–î–µ–π—Å—Ç–≤–∏—è</th>
        </tr>
      </thead>
      <tbody>
        <% 
        const reasonBadges = {
          'PREVIEW_ONLY': 'bg-warning text-dark',
          'PREVIEW_ONLY_YTDL': 'bg-warning text-dark',
          'FILE_TOO_LARGE': 'bg-danger',
          '403_FORBIDDEN': 'bg-info',
          'RATE_LIMIT': 'bg-secondary',
          'DOWNLOAD_ERROR': 'bg-danger',
          'UNKNOWN_ERROR': 'bg-dark'
        };
        const reasonLabels = {
          'PREVIEW_ONLY': 'üéß –¢–æ–ª—å–∫–æ –ø—Ä–µ–≤—å—é (SC)',
          'PREVIEW_ONLY_YTDL': 'üéß –¢–æ–ª—å–∫–æ –ø—Ä–µ–≤—å—é (YT-DLP)',
          'FILE_TOO_LARGE': 'üì¶ –§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π',
          '403_FORBIDDEN': 'üö´ –î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â—ë–Ω (403)',
          'RATE_LIMIT': '‚è±Ô∏è –õ–∏–º–∏—Ç –∑–∞–ø—Ä–æ—Å–æ–≤ (429)',
          'DOWNLOAD_ERROR': '‚ùå –û—à–∏–±–∫–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è',
          'UNKNOWN_ERROR': '‚ùì –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'
        };
        %>
        <% tracks.forEach((track) => { %>
          <tr data-id="<%= track.id %>" 
              data-reason="<%= track.reason || '' %>" 
              data-date="<%= track.created_at %>"
              data-title="<%= (track.title || '').toLowerCase() %>"
              data-url="<%= (track.url || '').toLowerCase() %>">
            <td>
              <input type="checkbox" class="form-check-input row-checkbox" value="<%= track.id %>" onchange="updateSelectedCount()">
            </td>
            <td>
              <% if (track.created_at) { %>
                <span class="text-muted" title="<%= new Date(track.created_at).toLocaleString('ru-RU') %>">
                  <%= new Date(track.created_at).toLocaleDateString('ru-RU') %>
                </span>
                <br>
                <small class="text-muted"><%= new Date(track.created_at).toLocaleTimeString('ru-RU', {hour: '2-digit', minute:'2-digit'}) %></small>
              <% } else { %>
                <span class="text-muted">‚Äî</span>
              <% } %>
            </td>
            <td>
              <a href="/user/<%= track.user_id %>" class="text-decoration-none">
                <% if (track.username) { %>
                  @<%= track.username %>
                <% } else if (track.first_name) { %>
                  <%= track.first_name %>
                <% } else { %>
                  <code><%= track.user_id %></code>
                <% } %>
              </a>
            </td>
            <td>
              <strong class="d-block text-truncate" style="max-width: 200px;" title="<%= track.title || '' %>">
                <%= track.title || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è' %>
              </strong>
            </td>
            <td>
              <span class="badge <%= reasonBadges[track.reason] || 'bg-dark' %>" 
                    title="<%= track.error_message || '' %>">
                <%= reasonLabels[track.reason] || track.reason || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ' %>
              </span>
              <% if (track.retry_count && track.retry_count > 0) { %>
                <br><small class="text-muted">–ü–æ–ø—ã—Ç–æ–∫: <%= track.retry_count %></small>
              <% } %>
            </td>
            <td>
              <div class="d-flex align-items-center gap-1">
                <a href="<%= track.url %>" target="_blank" class="text-truncate" style="max-width: 120px;" title="<%= track.url %>">
                  üîó –û—Ç–∫—Ä—ã—Ç—å
                </a>
                <button class="btn btn-sm btn-outline-secondary py-0 px-1" onclick="copyUrl('<%= track.url %>')" title="–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å">
                  üìã
                </button>
              </div>
            </td>
            <td>
              <div class="btn-group btn-group-sm" role="group">
                <button type="button" class="btn btn-outline-warning" 
                        onclick="fixAndSend('<%= track.id %>', '<%= track.url %>', '<%= track.user_id %>')" 
                        title="–ò—Å–ø—Ä–∞–≤–∏—Ç—å –∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é">
                  üì§
                </button>
                <button type="button" class="btn btn-outline-primary" 
                        onclick="retryDownload('<%= track.id %>', '<%= track.url %>')" 
                        title="–°–±—Ä–æ—Å–∏—Ç—å –∫—ç—à">
                  üîÑ
                </button>
                <button type="button" class="btn btn-outline-success" 
                        onclick="markFixed('<%= track.id %>', '<%= track.url %>')" 
                        title="–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ">
                  ‚úÖ
                </button>
                <button type="button" class="btn btn-outline-danger" 
                        onclick="deleteTrack('<%= track.id %>')" 
                        title="–£–¥–∞–ª–∏—Ç—å">
                  üóëÔ∏è
                </button>
              </div>
            </td>
          </tr>
        <% }) %>
      </tbody>
    </table>
  </div>

  <!-- üìÑ –ü–∞–≥–∏–Ω–∞—Ü–∏—è -->
  <% if (totalPages && totalPages > 1) { %>
  <nav aria-label="–ù–∞–≤–∏–≥–∞—Ü–∏—è" class="mt-4">
    <ul class="pagination justify-content-center">
      <li class="page-item <%= currentPage === 1 ? 'disabled' : '' %>">
        <a class="page-link" href="?page=<%= currentPage - 1 %>">‚Üê –ù–∞–∑–∞–¥</a>
      </li>
      
      <% for (let i = 1; i <= totalPages; i++) { %>
        <% if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) { %>
          <li class="page-item <%= i === currentPage ? 'active' : '' %>">
            <a class="page-link" href="?page=<%= i %>"><%= i %></a>
          </li>
        <% } else if (i === currentPage - 3 || i === currentPage + 3) { %>
          <li class="page-item disabled"><span class="page-link">...</span></li>
        <% } %>
      <% } %>
      
      <li class="page-item <%= currentPage === totalPages ? 'disabled' : '' %>">
        <a class="page-link" href="?page=<%= currentPage + 1 %>">–í–ø–µ—Ä—ë–¥ ‚Üí</a>
      </li>
    </ul>
  </nav>
  <% } %>

  <p class="text-muted text-center">
    –ü–æ–∫–∞–∑–∞–Ω–æ <%= tracks.length %> –∏–∑ <%= totalTracks || 0 %> –∑–∞–ø–∏—Å–µ–π
  </p>
<% } %>

<!-- üîî Toast —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è -->
<div class="toast-container position-fixed bottom-0 end-0 p-3" style="z-index: 9999;">
  <div id="toast" class="toast" role="alert">
    <div class="toast-header">
      <strong class="me-auto" id="toastTitle">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ</strong>
      <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
    </div>
    <div class="toast-body" id="toastBody"></div>
  </div>
</div>

<script>
// ===== –£—Ç–∏–ª–∏—Ç—ã =====

function showToast(title, message, type) {
  const toast = document.getElementById('toast');
  const toastTitle = document.getElementById('toastTitle');
  const toastBody = document.getElementById('toastBody');
  
  toastTitle.textContent = title;
  toastBody.textContent = message;
  
  // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∫–ª–∞—Å—Å—ã
  toast.className = 'toast';
  
  // –î–æ–±–∞–≤–ª—è–µ–º —Ü–≤–µ—Ç
  if (type === 'success') {
    toast.classList.add('bg-success', 'text-white');
  } else if (type === 'danger') {
    toast.classList.add('bg-danger', 'text-white');
  } else if (type === 'warning') {
    toast.classList.add('bg-warning');
  }
  
  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º
  const bsToast = new bootstrap.Toast(toast);
  bsToast.show();
}

function copyUrl(url) {
  if (navigator.clipboard && navigator.clipboard.writeText) {
    navigator.clipboard.writeText(url).then(function() {
      showToast('‚úÖ –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ', '–°—Å—ã–ª–∫–∞ –≤ –±—É—Ñ–µ—Ä–µ –æ–±–º–µ–Ω–∞', 'success');
    }).catch(function() {
      fallbackCopy(url);
    });
  } else {
    fallbackCopy(url);
  }
}

function fallbackCopy(text) {
  const input = document.createElement('input');
  input.value = text;
  document.body.appendChild(input);
  input.select();
  document.execCommand('copy');
  document.body.removeChild(input);
  showToast('‚úÖ –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ', '–°—Å—ã–ª–∫–∞ –≤ –±—É—Ñ–µ—Ä–µ –æ–±–º–µ–Ω–∞', 'success');
}

// ===== –í—ã–±–æ—Ä —Å—Ç—Ä–æ–∫ =====

function toggleSelectAll() {
  const selectAll = document.getElementById('selectAll');
  const checkboxes = document.querySelectorAll('.row-checkbox');
  
  checkboxes.forEach(function(cb) {
    const row = cb.closest('tr');
    if (row.style.display !== 'none') {
      cb.checked = selectAll.checked;
    }
  });
  
  updateSelectedCount();
}

function updateSelectedCount() {
  const count = document.querySelectorAll('.row-checkbox:checked').length;
  document.getElementById('selectedCount').textContent = count;
  document.getElementById('deleteSelectedBtn').disabled = count === 0;
}

// ===== –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è =====

function filterTable() {
  const search = document.getElementById('searchInput').value.toLowerCase();
  const reason = document.getElementById('reasonFilter').value;
  const dateFilter = document.getElementById('dateFilter').value;
  const now = new Date();
  
  const rows = document.querySelectorAll('#tracksTable tbody tr');
  
  rows.forEach(function(row) {
    const title = row.dataset.title || '';
    const url = row.dataset.url || '';
    const rowReason = row.dataset.reason || '';
    const rowDate = new Date(row.dataset.date);
    
    let show = true;
    
    // –ü–æ–∏—Å–∫ –ø–æ —Ç–µ–∫—Å—Ç—É
    if (search && !title.includes(search) && !url.includes(search)) {
      show = false;
    }
    
    // –§–∏–ª—å—Ç—Ä –ø–æ –ø—Ä–∏—á–∏–Ω–µ
    if (reason && rowReason !== reason) {
      show = false;
    }
    
    // –§–∏–ª—å—Ç—Ä –ø–æ –¥–∞—Ç–µ
    if (dateFilter) {
      const diff = (now - rowDate) / (1000 * 60 * 60 * 24);
      if (dateFilter === 'today' && diff > 1) show = false;
      if (dateFilter === 'week' && diff > 7) show = false;
      if (dateFilter === 'month' && diff > 30) show = false;
    }
    
    row.style.display = show ? '' : 'none';
  });
}

function clearFilters() {
  document.getElementById('searchInput').value = '';
  document.getElementById('reasonFilter').value = '';
  document.getElementById('dateFilter').value = '';
  filterTable();
}

// ===== –î–µ–π—Å—Ç–≤–∏—è —Å —Ç—Ä–µ–∫–∞–º–∏ =====

async function retryDownload(id, url) {
  const btn = event.target;
  const originalText = btn.innerHTML;
  btn.disabled = true;
  btn.innerHTML = '‚è≥';
  
  try {
    const response = await fetch('/api/broken-tracks/retry', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ id: id, url: url })
    });
    
    const result = await response.json();
    
    if (result.success) {
      showToast('‚úÖ –ì–æ—Ç–æ–≤–æ', result.message || '–ö—ç—à —Å–±—Ä–æ—à–µ–Ω', 'success');
      removeRow(id);
    } else {
      showToast('‚ùå –û—à–∏–±–∫–∞', result.error || '–ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã–ø–æ–ª–Ω–∏—Ç—å', 'danger');
      btn.disabled = false;
      btn.innerHTML = originalText;
    }
  } catch (err) {
    showToast('‚ùå –û—à–∏–±–∫–∞', '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞', 'danger');
    btn.disabled = false;
    btn.innerHTML = originalText;
  }
}

async function markFixed(id, url) {
  try {
    const response = await fetch('/api/broken-tracks/fix', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ id: id, url: url })
    });
    
    if (response.ok) {
      removeRow(id);
      showToast('‚úÖ –ì–æ—Ç–æ–≤–æ', '–ü–æ–º–µ—á–µ–Ω–æ –∫–∞–∫ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–æ–µ', 'success');
    } else {
      showToast('‚ùå –û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å', 'danger');
    }
  } catch (err) {
    showToast('‚ùå –û—à–∏–±–∫–∞', '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞', 'danger');
  }
}

async function fixAndSend(id, url, userId) {
  if (!confirm('–ò—Å–ø—Ä–∞–≤–∏—Ç—å —Ç—Ä–µ–∫ –∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é?')) return;
  
  const btn = event.target;
  const originalText = btn.innerHTML;
  btn.disabled = true;
  btn.innerHTML = '‚è≥';
  
  try {
    const response = await fetch('/api/broken-tracks/fix-and-send', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ id: id, url: url, userId: userId })
    });
    
    const result = await response.json();
    
    if (result.success) {
      showToast('‚úÖ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ', result.message || '–¢—Ä–µ–∫ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é', 'success');
      removeRow(id);
    } else {
      showToast('‚ùå –û—à–∏–±–∫–∞', result.error || '–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å', 'danger');
      btn.disabled = false;
      btn.innerHTML = originalText;
    }
  } catch (err) {
    showToast('‚ùå –û—à–∏–±–∫–∞', '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞', 'danger');
    btn.disabled = false;
    btn.innerHTML = originalText;
  }
}

async function deleteTrack(id) {
  if (!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç—É –∑–∞–ø–∏—Å—å?')) return;
  
  try {
    const response = await fetch('/api/broken-tracks/' + id, {
      method: 'DELETE'
    });
    
    if (response.ok) {
      removeRow(id);
      showToast('üóëÔ∏è –£–¥–∞–ª–µ–Ω–æ', '–ó–∞–ø–∏—Å—å —É–¥–∞–ª–µ–Ω–∞', 'warning');
    } else {
      showToast('‚ùå –û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å', 'danger');
    }
  } catch (err) {
    showToast('‚ùå –û—à–∏–±–∫–∞', '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞', 'danger');
  }
}

async function deleteSelected() {
  const checkboxes = document.querySelectorAll('.row-checkbox:checked');
  const ids = [];
  
  checkboxes.forEach(function(cb) {
    ids.push(cb.value);
  });
  
  if (ids.length === 0) return;
  if (!confirm('–£–¥–∞–ª–∏—Ç—å ' + ids.length + ' –∑–∞–ø–∏—Å–µ–π?')) return;
  
  try {
    const response = await fetch('/api/broken-tracks/bulk-delete', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ ids: ids })
    });
    
    if (response.ok) {
      ids.forEach(function(id) {
        removeRow(id);
      });
      showToast('üóëÔ∏è –£–¥–∞–ª–µ–Ω–æ', ids.length + ' –∑–∞–ø–∏—Å–µ–π —É–¥–∞–ª–µ–Ω–æ', 'warning');
      document.getElementById('selectAll').checked = false;
      updateSelectedCount();
    } else {
      showToast('‚ùå –û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å', 'danger');
    }
  } catch (err) {
    showToast('‚ùå –û—à–∏–±–∫–∞', '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞', 'danger');
  }
}

function removeRow(id) {
  const row = document.querySelector('tr[data-id="' + id + '"]');
  if (row) {
    row.style.transition = 'opacity 0.3s, transform 0.3s';
    row.style.opacity = '0';
    row.style.transform = 'translateX(20px)';
    setTimeout(function() {
      row.remove();
    }, 300);
  }
}

// ===== –≠–∫—Å–ø–æ—Ä—Ç CSV =====

function exportCSV() {
  const rows = document.querySelectorAll('#tracksTable tbody tr');
  let csv = '–î–∞—Ç–∞,User ID,–¢—Ä–µ–∫,–û—à–∏–±–∫–∞,URL\n';
  
  rows.forEach(function(row) {
    if (row.style.display !== 'none') {
      const date = row.dataset.date || '';
      const userCell = row.querySelector('td:nth-child(3)');
      const userId = userCell ? userCell.textContent.trim() : '';
      const title = row.dataset.title || '';
      const reason = row.dataset.reason || '';
      const url = row.dataset.url || '';
      
      csv += '"' + date + '","' + userId + '","' + title + '","' + reason + '","' + url + '"\n';
    }
  });
  
  // BOM –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∫–∏—Ä–∏–ª–ª–∏—Ü—ã –≤ Excel
  const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
  const link = document.createElement('a');
  const dateStr = new Date().toISOString().slice(0, 10);
  
  link.href = URL.createObjectURL(blob);
  link.download = 'broken_tracks_' + dateStr + '.csv';
  link.click();
  
  showToast('üì• –≠–∫—Å–ø–æ—Ä—Ç', 'CSV —Ñ–∞–π–ª —Å–∫–∞—á–∞–Ω', 'success');
}

// ===== –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ =====

var sortDirections = {};

function sortTable(columnIndex) {
  const table = document.getElementById('tracksTable');
  const tbody = table.querySelector('tbody');
  const rows = Array.from(tbody.querySelectorAll('tr'));
  
  sortDirections[columnIndex] = !sortDirections[columnIndex];
  const direction = sortDirections[columnIndex] ? 1 : -1;
  
  rows.sort(function(a, b) {
    let aVal, bVal;
    
    if (columnIndex === 0) {
      // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ –¥–∞—Ç–µ
      aVal = new Date(a.dataset.date);
      bVal = new Date(b.dataset.date);
    } else if (columnIndex === 2) {
      // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é —Ç—Ä–µ–∫–∞
      aVal = a.dataset.title || '';
      bVal = b.dataset.title || '';
    }
    
    if (aVal < bVal) return -1 * direction;
    if (aVal > bVal) return 1 * direction;
    return 0;
  });
  
  rows.forEach(function(row) {
    tbody.appendChild(row);
  });
}
</script>

<style>
.table th[onclick] {
  user-select: none;
}

.table th[onclick]:hover {
  background-color: rgba(255, 255, 255, 0.1) !important;
  cursor: pointer;
}

.btn-group-sm > .btn {
  padding: 0.2rem 0.4rem;
}

.card {
  transition: transform 0.2s;
}

.card:hover {
  transform: translateY(-2px);
}

.toast {
  min-width: 280px;
}
</style>
